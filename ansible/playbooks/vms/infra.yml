- name: "Install Traefik"
  hosts: infra
  gather_facts: true
  become: true
  roles:
    - traefik

- name: "Deploy Checkmk server"
  hosts: infra
  roles:
     - checkmk.general.server
  tags:
    - checkmk_server

- name: "Config traefik for Checkmk"
  hosts: infra
  tasks:
  - name: Add Checkmk dynamic config
    include_role:
      name: traefik
      tasks_from: configure_service
    vars:
      traefik_conf:
        filename: checkmk.yml
        content: |
          http:
            routers:
              checkmk:
                rule: "Host(`checkmk.{{ traefik_local_domain }}`)"
                entryPoints:
                  - https
                service: checkmk-service
                middlewares:
                  - checkmk-redirect
                tls:
                  certResolver: {{ traefik_cert_resolver_name }}

            middlewares:
              checkmk-redirect:
                redirectRegex:
                  regex: "^https://checkmk.{{ traefik_local_domain }}/$"
                  replacement: "https://checkmk.{{ traefik_local_domain }}/homelab/check_mk/"
                  permanent: true

            services:
              checkmk-service:
                loadBalancer:
                  servers:
                    - url: "http://127.0.0.1:5000"
